--- /workspace/project_original/server/src/main/java/com/alibaba/otter/canal/common/MQMessageUtils.java	2026-01-09 23:03:43.000000000 +0000
+++ server/src/main/java/com/alibaba/otter/canal/common/MQMessageUtils.java	2026-02-12 06:04:00.144079489 +0000
@@ -365,9 +365,10 @@
                 List<Map<String, String>> data = new ArrayList<>();
                 List<Map<String, String>> old = new ArrayList<>();
 
-                Set<String> updateSet = new HashSet<>();
                 boolean hasInitPkNames = false;
                 for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) {
+                    // 每一行建立独立的update字段集合，避免跨行污染
+                    Set<String> updateSet = new HashSet<>();
                     if (eventType != CanalEntry.EventType.INSERT && eventType != CanalEntry.EventType.UPDATE
                         && eventType != CanalEntry.EventType.DELETE) {
                         continue;
--- /workspace/project_original/server/src/main/java/com/alibaba/otter/canal/rabbitmq/CanalRabbitMQProducer.java	2026-01-09 23:03:43.000000000 +0000
+++ server/src/main/java/com/alibaba/otter/canal/rabbitmq/CanalRabbitMQProducer.java	2026-02-12 06:06:37.598208656 +0000
@@ -117,10 +117,23 @@
     public void stop() {
         logger.info("## Stop RabbitMQ producer##");
         try {
-            this.connect.close();
-            this.channel.close();
-        } catch (IOException | TimeoutException ex) {
-            throw new CanalServerException("Stop RabbitMQ producer error", ex);
+            // close channel first then connection
+            if (this.channel != null) {
+                try {
+                    this.channel.close();
+                } catch (IOException | TimeoutException ex) {
+                    logger.warn("Close RabbitMQ channel error", ex);
+                }
+            }
+            if (this.connect != null) {
+                try {
+                    this.connect.close();
+                } catch (IOException ex) {
+                    logger.warn("Close RabbitMQ connection error", ex);
+                }
+            }
+        } catch (Throwable ex) {
+            logger.warn("Stop RabbitMQ producer error", ex);
         }
 
         super.stop();
